import { createContext, useContext, useEffect, useMemo, useState, type ReactNode } from "react";

export type Locale = "en" | "zh-CN";

type MessageKey = string;

type LocaleContextValue = {
  locale: Locale;
  setLocale: (locale: Locale) => void;
  t: (key: MessageKey, params?: Record<string, string | number>) => string;
};

export const LOCALE_STORAGE_KEY = "cursorlens.locale";

const messages: Record<Locale, Record<string, string>> = {
  en: {
    "app.name": "CursorLens",
    "app.fallbackTitle": "CursorLens",
    "common.cancel": "Cancel",
    "common.close": "Close",
    "common.done": "Done",
    "common.loading": "Loading...",
    "common.processing": "Processing...",
    "common.status": "Status",
    "common.format": "Format",
    "common.frames": "Frames",
    "common.loop": "Loop",
    "common.language": "Language",
    "common.english": "English",
    "common.chinese": "简体中文",

    "launch.sourceFallback": "Screen",
    "launch.record": "Record",
    "launch.open": "Open",
    "launch.camera": "Camera",
    "launch.cameraEnabled": "Camera overlay enabled",
    "launch.cameraEnable": "Enable camera overlay",
    "launch.shape": "Shape",
    "launch.shape.rounded": "Rounded",
    "launch.shape.square": "Square",
    "launch.shape.circle": "Circle",
    "launch.cameraShapeLabel": "Camera shape: {{shape}}",
    "launch.sizeDecrease": "Decrease camera size",
    "launch.sizeIncrease": "Increase camera size",
    "launch.captureProfile.balanced": "Balanced",
    "launch.captureProfile.quality": "Quality",
    "launch.captureProfile.ultra": "Ultra 120",
    "launch.captureProfileLabel": "Capture profile: {{profile}}",
    "launch.hideHud": "Hide HUD",
    "launch.closeApp": "Close App",

    "source.loading": "Loading sources...",
    "source.screens": "Screens",
    "source.windows": "Windows",
    "source.cancel": "Cancel",
    "source.share": "Share",
    "source.appIcon": "App icon",

    "playback.play": "Play",
    "playback.pause": "Pause",

    "editor.loadingVideo": "Loading video...",
    "editor.loadVideoError": "Error loading video: {{message}}",
    "editor.noVideo": "No video to load. Please record or select a video.",
    "editor.videoNotReady": "Video not ready",
    "editor.noVideoLoaded": "No video loaded",
    "editor.exportCancelled": "Export cancelled",
    "editor.gifExportSuccess": "GIF exported successfully to {{path}}",
    "editor.videoExportSuccess": "Video exported successfully to {{path}}",
    "editor.saveGifFailed": "Failed to save GIF",
    "editor.saveVideoFailed": "Failed to save video",
    "editor.gifExportFailed": "GIF export failed",
    "editor.exportFailed": "Export failed",
    "editor.exportError": "Export failed: {{message}}",

    "settings.zoomLevel": "Zoom Level",
    "settings.selectZoomToAdjust": "Select a zoom region to adjust",
    "settings.deleteZoom": "Delete Zoom",
    "settings.deleteTrim": "Delete Trim Region",
    "settings.videoEffects": "Video Effects",
    "settings.motionBlur": "Motion Blur",
    "settings.blurBg": "Blur BG",
    "settings.shadow": "Shadow",
    "settings.roundness": "Roundness",
    "settings.padding": "Padding",
    "settings.cropVideo": "Crop Video",
    "settings.background": "Background",
    "settings.backgroundImage": "Image",
    "settings.backgroundColor": "Color",
    "settings.backgroundGradient": "Gradient",
    "settings.uploadCustom": "Upload Custom",
    "settings.cropDialogTitle": "Crop Video",
    "settings.cropDialogDesc": "Drag on each side to adjust the crop area",
    "settings.exportVideo": "Export {{format}}",
    "settings.reportBug": "Report Bug",
    "settings.starGithub": "Star on GitHub",
    "settings.quality.low": "Low",
    "settings.quality.medium": "Medium",
    "settings.quality.high": "High",
    "settings.gif.original": "Orig",
    "settings.fileTypeInvalid": "Invalid file type",
    "settings.uploadJpgOnly": "Please upload a JPG or JPEG image file.",
    "settings.uploadOk": "Custom image uploaded successfully!",
    "settings.uploadFailed": "Failed to upload image",
    "settings.uploadReadError": "There was an error reading the file.",

    "export.title": "Exporting {{format}}",
    "export.titleCompilingGif": "Compiling GIF",
    "export.titleFailed": "Export Failed",
    "export.statusTryAgain": "Please try again",
    "export.statusMoment": "This may take a moment...",
    "export.statusCompiling": "Compiling GIF... This may take a while",
    "export.statusCompilingPct": "Compiling GIF... {{progress}}%",
    "export.phaseCompiling": "Compiling",
    "export.phaseRendering": "Rendering Frames",
    "export.complete": "Export Complete",
    "export.ready": "Your {{format}} is ready",
    "export.cancelExport": "Cancel Export",
    "export.saved": "{{format}} saved successfully!",

    "format.mp4.label": "MP4 Video",
    "format.mp4.desc": "High quality video file",
    "format.gif.label": "GIF Animation",
    "format.gif.desc": "Animated image for sharing",

    "gif.frameRate": "Frame Rate",
    "gif.outputSize": "Output Size",
    "gif.loopAnimation": "Loop Animation",
    "gif.loopDesc": "GIF will play continuously",

    "shortcut.title": "Keyboard Shortcuts",
    "shortcut.addZoom": "Add Zoom",
    "shortcut.addAnnotation": "Add Annotation",
    "shortcut.addKeyframe": "Add Keyframe",
    "shortcut.addTrim": "Add Trim",
    "shortcut.deleteSelected": "Delete Selected",
    "shortcut.panTimeline": "Pan Timeline",
    "shortcut.zoomTimeline": "Zoom Timeline",
    "shortcut.playPause": "Pause/Play",

    "tutorial.trigger": "How trimming works",
    "tutorial.title": "How Trimming Works",
    "tutorial.desc": "Understanding how to cut out unwanted parts of your video.",
    "tutorial.explain": "The Trim tool works by defining the segments you want to remove. Any part covered by a red trim segment will be cut out when you export.",
    "tutorial.visualExample": "Visual Example",
    "tutorial.removed": "REMOVED",
    "tutorial.kept": "Kept",
    "tutorial.part": "Part {{index}}",
    "tutorial.finalVideo": "Final Video",
    "tutorial.step1": "1. Add Trim",
    "tutorial.step1desc": "Press T or click the scissors icon to mark a section for removal.",
    "tutorial.step2": "2. Adjust",
    "tutorial.step2desc": "Drag the edges of the red region to cover exactly what you want to cut out.",

    "annotation.settings": "Annotation Settings",
    "annotation.active": "Active",
    "annotation.tab.text": "Text",
    "annotation.tab.image": "Image",
    "annotation.tab.figure": "Arrow",
    "annotation.textContent": "Text Content",
    "annotation.enterText": "Enter your text...",
    "annotation.fontStyle": "Font Style",
    "annotation.size": "Size",
    "annotation.selectStyle": "Select style",
    "annotation.background": "Background",
    "annotation.none": "None",
    "annotation.color": "Color",
    "annotation.clearBackground": "Clear Background",
    "annotation.uploadImage": "Upload Image",
    "annotation.uploadedImage": "Uploaded annotation",
    "annotation.supportedFormats": "Supported formats: JPG, PNG, GIF, WebP",
    "annotation.arrowDirection": "Arrow Direction",
    "annotation.strokeWidth": "Stroke Width: {{value}}px",
    "annotation.arrowColor": "Arrow Color",
    "annotation.textColor": "Text Color",
    "annotation.delete": "Delete Annotation",
    "annotation.shortcutTips": "Shortcuts & Tips",
    "annotation.tip1": "Move playhead to overlapping annotation section and select an item.",
    "annotation.tip2": "Use Tab to cycle through overlapping items.",
    "annotation.tip3": "Use Shift+Tab to cycle backwards.",
    "annotation.invalidType": "Invalid file type",
    "annotation.allowedTypes": "Please upload a JPG, PNG, GIF, or WebP image file.",
    "annotation.imageUploadOk": "Image uploaded successfully!",

    "font.addGoogle": "Add Google Font",
    "font.dialogTitle": "Add Google Font",
    "font.dialogDesc": "Add a custom font from Google Fonts to use in your annotations.",
    "font.importUrl": "Google Fonts Import URL",
    "font.importHint": "Get this from Google Fonts: Select a font -> Click \"Get font\" -> Copy the @import URL",
    "font.importPlaceholder": "https://fonts.googleapis.com/css2?family=Roboto&display=swap",
    "font.displayName": "Display Name",
    "font.displayHint": "This is how the font will appear in the font selector",
    "font.namePlaceholder": "My Custom Font",
    "font.customFonts": "Custom Fonts",
    "font.adding": "Adding...",
    "font.add": "Add Font",
    "font.error.enterUrl": "Please enter a Google Fonts import URL",
    "font.error.invalidUrl": "Please enter a valid Google Fonts URL",
    "font.error.enterName": "Please enter a font name",
    "font.error.extract": "Could not extract font family from URL",
    "font.added": "Font \"{{name}}\" added successfully",
    "font.failed": "Failed to add font",
    "font.failed.timeout": "Font took too long to load. Please check the URL and try again.",
    "font.failed.generic": "The font could not be loaded. Please verify the Google Fonts URL is correct.",

    "timeline.noVideoLoaded": "No Video Loaded",
    "timeline.dragDropToStart": "Drag and drop a video to start editing",
    "timeline.cannotPlaceZoom": "Cannot place zoom here",
    "timeline.cannotPlaceZoomDesc": "Zoom already exists at this location or not enough space available.",
    "timeline.cannotPlaceTrim": "Cannot place trim here",
    "timeline.cannotPlaceTrimDesc": "Trim already exists at this location or not enough space available.",
    "timeline.zoom": "Zoom",
    "timeline.trim": "Trim",
    "timeline.annotation": "Annotation",
    "timeline.image": "Image",
    "timeline.emptyText": "Empty text",
    "timeline.pan": "Pan",
    "timeline.zoomAction": "Zoom",
    "timeline.addZoom": "Add Zoom (Z)",
    "timeline.addTrim": "Add Trim (T)",
    "timeline.addAnnotation": "Add Annotation (A)",
    "timeline.resizeLeft": "Resize left",
    "timeline.resizeRight": "Resize right",

    "electron.tray.openScreen": "CursorLens",
    "electron.tray.recording": "Recording: {{source}}",
    "electron.tray.stopRecording": "Stop Recording",
    "electron.tray.open": "Open",
    "electron.tray.quit": "Quit",
    "electron.saveGif": "Save Exported GIF",
    "electron.saveVideo": "Save Exported Video",
    "electron.exportCancelled": "Export cancelled",
    "electron.exportSaved": "Video exported successfully",
    "electron.exportSaveFailed": "Failed to save exported video",
    "electron.selectVideoFile": "Select Video File",
    "electron.videoFiles": "Video Files",
    "electron.allFiles": "All Files",
    "electron.filePickerFailed": "Failed to open file picker"
  },
  "zh-CN": {
    "app.name": "CursorLens",
    "app.fallbackTitle": "CursorLens",
    "common.cancel": "取消",
    "common.close": "关闭",
    "common.done": "完成",
    "common.loading": "加载中...",
    "common.processing": "处理中...",
    "common.status": "状态",
    "common.format": "格式",
    "common.frames": "帧数",
    "common.loop": "循环",
    "common.language": "语言",
    "common.english": "English",
    "common.chinese": "简体中文",

    "launch.sourceFallback": "屏幕",
    "launch.record": "录制",
    "launch.open": "打开",
    "launch.camera": "摄像头",
    "launch.cameraEnabled": "已启用摄像头画中画",
    "launch.cameraEnable": "启用摄像头画中画",
    "launch.shape": "形状",
    "launch.shape.rounded": "圆角",
    "launch.shape.square": "方形",
    "launch.shape.circle": "圆形",
    "launch.cameraShapeLabel": "摄像头形状：{{shape}}",
    "launch.sizeDecrease": "减小摄像头尺寸",
    "launch.sizeIncrease": "增大摄像头尺寸",
    "launch.captureProfile.balanced": "流畅 30",
    "launch.captureProfile.quality": "高质 60",
    "launch.captureProfile.ultra": "极限 120",
    "launch.captureProfileLabel": "录制档位：{{profile}}",
    "launch.hideHud": "隐藏悬浮窗",
    "launch.closeApp": "关闭应用",

    "source.loading": "正在加载可录制来源...",
    "source.screens": "屏幕",
    "source.windows": "窗口",
    "source.cancel": "取消",
    "source.share": "共享",
    "source.appIcon": "应用图标",

    "playback.play": "播放",
    "playback.pause": "暂停",

    "editor.loadingVideo": "正在加载视频...",
    "editor.loadVideoError": "加载视频出错：{{message}}",
    "editor.noVideo": "没有可加载的视频，请先录制或选择一个视频文件。",
    "editor.videoNotReady": "视频尚未就绪",
    "editor.noVideoLoaded": "未加载视频",
    "editor.exportCancelled": "导出已取消",
    "editor.gifExportSuccess": "GIF 导出成功：{{path}}",
    "editor.videoExportSuccess": "视频导出成功：{{path}}",
    "editor.saveGifFailed": "保存 GIF 失败",
    "editor.saveVideoFailed": "保存视频失败",
    "editor.gifExportFailed": "GIF 导出失败",
    "editor.exportFailed": "导出失败",
    "editor.exportError": "导出失败：{{message}}",

    "settings.zoomLevel": "缩放级别",
    "settings.selectZoomToAdjust": "请选择一个缩放片段后再调整",
    "settings.deleteZoom": "删除缩放",
    "settings.deleteTrim": "删除裁剪片段",
    "settings.videoEffects": "视频效果",
    "settings.motionBlur": "运动模糊",
    "settings.blurBg": "背景模糊",
    "settings.shadow": "阴影",
    "settings.roundness": "圆角",
    "settings.padding": "边距",
    "settings.cropVideo": "裁剪视频",
    "settings.background": "背景",
    "settings.backgroundImage": "图片",
    "settings.backgroundColor": "纯色",
    "settings.backgroundGradient": "渐变",
    "settings.uploadCustom": "上传自定义",
    "settings.cropDialogTitle": "裁剪视频",
    "settings.cropDialogDesc": "拖动四边来调整裁剪区域",
    "settings.exportVideo": "导出 {{format}}",
    "settings.reportBug": "反馈问题",
    "settings.starGithub": "给项目点星",
    "settings.quality.low": "低",
    "settings.quality.medium": "中",
    "settings.quality.high": "高",
    "settings.gif.original": "原始",
    "settings.fileTypeInvalid": "文件类型无效",
    "settings.uploadJpgOnly": "请上传 JPG 或 JPEG 图片文件。",
    "settings.uploadOk": "自定义图片上传成功！",
    "settings.uploadFailed": "图片上传失败",
    "settings.uploadReadError": "读取文件时发生错误。",

    "export.title": "正在导出 {{format}}",
    "export.titleCompilingGif": "正在合成 GIF",
    "export.titleFailed": "导出失败",
    "export.statusTryAgain": "请重试",
    "export.statusMoment": "这可能需要一点时间...",
    "export.statusCompiling": "正在合成 GIF... 可能需要一些时间",
    "export.statusCompilingPct": "正在合成 GIF... {{progress}}%",
    "export.phaseCompiling": "合成中",
    "export.phaseRendering": "渲染帧",
    "export.complete": "导出完成",
    "export.ready": "你的 {{format}} 已就绪",
    "export.cancelExport": "取消导出",
    "export.saved": "{{format}} 已保存成功！",

    "format.mp4.label": "MP4 视频",
    "format.mp4.desc": "高质量视频文件",
    "format.gif.label": "GIF 动图",
    "format.gif.desc": "适合分享的动画图片",

    "gif.frameRate": "帧率",
    "gif.outputSize": "输出尺寸",
    "gif.loopAnimation": "循环播放",
    "gif.loopDesc": "GIF 将持续循环",

    "shortcut.title": "快捷键",
    "shortcut.addZoom": "添加缩放",
    "shortcut.addAnnotation": "添加注释",
    "shortcut.addKeyframe": "添加关键帧",
    "shortcut.addTrim": "添加裁剪",
    "shortcut.deleteSelected": "删除选中",
    "shortcut.panTimeline": "平移时间线",
    "shortcut.zoomTimeline": "缩放时间线",
    "shortcut.playPause": "播放/暂停",

    "tutorial.trigger": "裁剪说明",
    "tutorial.title": "裁剪如何工作",
    "tutorial.desc": "了解如何剪掉视频中不需要的部分。",
    "tutorial.explain": "裁剪工具通过定义你想移除的时间段来工作。时间线上被红色裁剪段覆盖的部分，在导出时会被剪掉。",
    "tutorial.visualExample": "可视化示例",
    "tutorial.removed": "已删除",
    "tutorial.kept": "保留",
    "tutorial.part": "片段 {{index}}",
    "tutorial.finalVideo": "最终视频",
    "tutorial.step1": "1. 添加裁剪段",
    "tutorial.step1desc": "按 T 或点击剪刀图标，标记需要删除的区间。",
    "tutorial.step2": "2. 调整范围",
    "tutorial.step2desc": "拖动红色区域边缘，精确覆盖要剪掉的部分。",

    "annotation.settings": "注释设置",
    "annotation.active": "已激活",
    "annotation.tab.text": "文本",
    "annotation.tab.image": "图片",
    "annotation.tab.figure": "箭头",
    "annotation.textContent": "文本内容",
    "annotation.enterText": "输入文本...",
    "annotation.fontStyle": "字体样式",
    "annotation.size": "大小",
    "annotation.selectStyle": "选择样式",
    "annotation.background": "背景",
    "annotation.none": "无",
    "annotation.color": "颜色",
    "annotation.clearBackground": "清除背景",
    "annotation.uploadImage": "上传图片",
    "annotation.uploadedImage": "已上传注释图片",
    "annotation.supportedFormats": "支持格式：JPG、PNG、GIF、WebP",
    "annotation.arrowDirection": "箭头方向",
    "annotation.strokeWidth": "描边宽度：{{value}}px",
    "annotation.arrowColor": "箭头颜色",
    "annotation.textColor": "文字颜色",
    "annotation.delete": "删除注释",
    "annotation.shortcutTips": "快捷键与提示",
    "annotation.tip1": "将播放头移动到注释重叠区间后选择一个项目。",
    "annotation.tip2": "使用 Tab 在重叠项目间循环选择。",
    "annotation.tip3": "使用 Shift+Tab 反向循环。",
    "annotation.invalidType": "文件类型无效",
    "annotation.allowedTypes": "请上传 JPG、PNG、GIF 或 WebP 图片文件。",
    "annotation.imageUploadOk": "图片上传成功！",

    "font.addGoogle": "添加 Google 字体",
    "font.dialogTitle": "添加 Google 字体",
    "font.dialogDesc": "从 Google Fonts 添加自定义字体，用于注释内容。",
    "font.importUrl": "Google Fonts 导入链接",
    "font.importHint": "在 Google Fonts 中选择字体 -> 点击 Get font -> 复制 @import 链接",
    "font.importPlaceholder": "https://fonts.googleapis.com/css2?family=Roboto&display=swap",
    "font.displayName": "显示名称",
    "font.displayHint": "该名称将显示在字体选择器中",
    "font.namePlaceholder": "我的自定义字体",
    "font.customFonts": "自定义字体",
    "font.adding": "添加中...",
    "font.add": "添加字体",
    "font.error.enterUrl": "请输入 Google Fonts 导入链接",
    "font.error.invalidUrl": "请输入有效的 Google Fonts 链接",
    "font.error.enterName": "请输入字体名称",
    "font.error.extract": "无法从链接中解析字体族",
    "font.added": "字体“{{name}}”添加成功",
    "font.failed": "添加字体失败",
    "font.failed.timeout": "字体加载超时，请检查链接后重试。",
    "font.failed.generic": "字体加载失败，请确认 Google Fonts 链接是否正确。",

    "timeline.noVideoLoaded": "未加载视频",
    "timeline.dragDropToStart": "拖入一个视频开始编辑",
    "timeline.cannotPlaceZoom": "此处无法添加缩放",
    "timeline.cannotPlaceZoomDesc": "该位置已有缩放片段，或剩余空间不足。",
    "timeline.cannotPlaceTrim": "此处无法添加裁剪",
    "timeline.cannotPlaceTrimDesc": "该位置已有裁剪片段，或剩余空间不足。",
    "timeline.zoom": "缩放",
    "timeline.trim": "裁剪",
    "timeline.annotation": "注释",
    "timeline.image": "图片",
    "timeline.emptyText": "空文本",
    "timeline.pan": "平移",
    "timeline.zoomAction": "缩放",
    "timeline.addZoom": "添加缩放 (Z)",
    "timeline.addTrim": "添加裁剪 (T)",
    "timeline.addAnnotation": "添加注释 (A)",
    "timeline.resizeLeft": "向左调整",
    "timeline.resizeRight": "向右调整",

    "electron.tray.openScreen": "CursorLens",
    "electron.tray.recording": "录制中：{{source}}",
    "electron.tray.stopRecording": "停止录制",
    "electron.tray.open": "打开",
    "electron.tray.quit": "退出",
    "electron.saveGif": "保存导出 GIF",
    "electron.saveVideo": "保存导出视频",
    "electron.exportCancelled": "导出已取消",
    "electron.exportSaved": "视频导出成功",
    "electron.exportSaveFailed": "保存导出视频失败",
    "electron.selectVideoFile": "选择视频文件",
    "electron.videoFiles": "视频文件",
    "electron.allFiles": "所有文件",
    "electron.filePickerFailed": "打开文件选择器失败"
  }
};

const LocaleContext = createContext<LocaleContextValue | null>(null);

export function normalizeLocale(input: string | null | undefined): Locale {
  const value = (input ?? "").toLowerCase();
  return value.startsWith("zh") ? "zh-CN" : "en";
}

export function getLocaleFromStorage(): Locale {
  try {
    return normalizeLocale(window.localStorage.getItem(LOCALE_STORAGE_KEY) || window.navigator.language);
  } catch {
    return "en";
  }
}

function interpolate(template: string, params: Record<string, string | number>): string {
  return template.replace(/\{\{(\w+)\}\}/g, (_s: string, token: string) => String(params[token] ?? ""));
}

export function I18nProvider({ children }: { children: ReactNode }) {
  const [locale, setLocaleState] = useState<Locale>(getLocaleFromStorage);

  useEffect(() => {
    try {
      window.localStorage.setItem(LOCALE_STORAGE_KEY, locale);
    } catch {
      // no-op
    }
    document.documentElement.lang = locale;
  }, [locale]);

  const value = useMemo<LocaleContextValue>(() => ({
    locale,
    setLocale: (next) => setLocaleState(next),
    t: (key, params = {}) => {
      const template = messages[locale][key] ?? messages.en[key] ?? key;
      return interpolate(template, params);
    },
  }), [locale]);

  return <LocaleContext.Provider value={value}>{children}</LocaleContext.Provider>;
}

export function useI18n() {
  const context = useContext(LocaleContext);
  if (!context) {
    throw new Error("useI18n must be used within I18nProvider");
  }
  return context;
}
